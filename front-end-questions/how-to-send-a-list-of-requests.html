<script type="text/javascript">

/*
implement each function:
iteratee will be invoked with (item, callback);
callback function can take an error.
 */

let each = (collections, iteratee, callback) => {
    let count = 0;
    let errorHappened = false;

    collections.forEach(item => {
        iteratee(item,
                (error) => {
                    if (errorHappened) {
                        return;
                    }

                    if (error) {
                        console.log(error);
                        errorHappened = true;
                        callback("terminate");
                    } else {
                        console.log(item + ' response');
                        count++;
                        if (count == collections.length) {
                            callback();
                        }
                    }
                 });
    })
}

let iteratee = (item, singleRequestCallback) => {
    console.log('sending request for ' + item);
    setTimeout(
        () => {
            if (Math.random() < 0.25) {
                singleRequestCallback("one request failed");
            } else {
                singleRequestCallback();
            }
        },
        Math.random() * 5000);
}

let callback = (error) => {
    if (error) {
        console.log(error);
    } else {
        console.log("all requests finished successfully");
    }
}


let collections = ["item1", "item2", "item3", "item4"];

each(collections, iteratee, callback);

</script>